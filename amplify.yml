version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - npm ci
        build:
          commands:
            - |
              echo "Creating .env from single Secrets Manager JSON secret"
              : > .env
              SECRET_ID="$APP_SECRET_ARN"
              if [ -z "$SECRET_ID" ]; then
                echo "APP_SECRET_ARN not set"
                exit 1
              fi
              SECRET_STRING="$(aws secretsmanager get-secret-value --secret-id "$SECRET_ID" --region "$AWS_REGION" --query 'SecretString' --output text 2>/dev/null || true)"
              if [ -z "$SECRET_STRING" ] || [ "$SECRET_STRING" = "None" ]; then
                echo "Failed to retrieve SecretString for $SECRET_ID"
                exit 1
              fi
              SECRET_STRING="$SECRET_STRING" node -e "const fs=require('fs');const raw=process.env.SECRET_STRING||'';let obj;try{obj=JSON.parse(raw);}catch(e){console.error('Invalid JSON in secret payload');process.exit(1);}const lines=Object.entries(obj).map(([k,v])=>{const val=String(v).replace(/\r?\n/g,'\\\\n');return \`\${k}=\${val}\`;});if(lines.length){fs.appendFileSync('.env',lines.join('\n')+'\\n');}"
              echo "Generated $(wc -l < .env) entries in .env"
            - npm run build
      artifacts:
        baseDirectory: .next
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
